//
//  HomeAmuseViewController.m
//  HM-HEALTH
//
//  Created by apple on 14-5-26.
//  Copyright (c) 2014年 PingAn. All rights reserved.
//


#import "HomeAmuseViewController.h"
#import "JKPedViewController.h"
#import "JKTestLoginViewController.h"
#import "JKActivityIndexViewController.h"
#import "JKQuickAskDoctorIndexViewController.h"
#import "JKSettingViewController.h"
#import "IndividualInfoViewController.h"
#import "JKOrderDoctorViewController.h"
#import "JKLoginViewController.h"
#import "JKBusinessInputView.h"
#import "YLListMenuCell.h"
#import "IQKeyBoardManager.h"
#import "JKMsgMainViewController.h"
#import "IndividualInfoViewController.h"
#import "JKMsgUtil.h"
#import "JKHomeActivityViewController.h"
//#import "JKHealthCheckHomeViewController.h"
#import "JKHCProductViewController.h"
#import "JKChooseAreaViewController.h"

@interface HomeAmuseViewController ()<UITableViewDelegate, UITableViewDataSource>
{
    ///显示底部空白行数量
    int bottomNum;
}

@property (nonatomic, strong) NSMutableArray *dataSource;

@end

@implementation HomeAmuseViewController

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        self.title = @"娱乐宝";
        self.navigationItem.title = @"";
        [self.tabBarItem setFinishedSelectedImage:[UIImage imageNamed:@"tab_amuse_selected.png"] withFinishedUnselectedImage:[UIImage imageNamed:@"tab_amuse_unselect.png"]];
        // Custom initialization
    }
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(showRedMsgBtn) name:@"HAVE_MSG" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(showNoMsgBtn) name:@"HAVE_NO_MSG" object:nil];
    return self;
}

- (void)awakeFromNib
{
    UIImageView *bg = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"base_bg_iphone5"]];
    [self.view addSubview:bg];
}

- (void)addBussinessIdSuccess:(NSNotification *)notif
{
    if (![[JKUserUtil currentUser] profileFull]) {
        IndividualInfoViewController *vc = [[IndividualInfoViewController alloc] init];
        vc.hidesBottomBarWhenPushed = YES;
        vc.viewController = @"JKActivityIndexViewController";
        [self.navigationController pushViewController:vc animated:YES];
    }
    else {
//        JKActivityIndexViewController *vc = [[JKActivityIndexViewController alloc] init];//old
        JKHomeActivityViewController *vc = [[JKHomeActivityViewController alloc] init];
        vc.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vc animated:YES];
    }
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(addBussinessIdSuccess:) name:@"kAddBussinessIdSuccess" object:nil];
    bottomNum = 1;
    
    if (!IOS7) {
        CGRect frame = self.listMenu.frame;
        frame.origin.y -= 40;
        frame.size.height += 40;
        [self.listMenu setFrame:frame];
        
        self.bgImage.image = [UIImage imageNamed:@"home_back_OS6"];
        self.bgImage.contentMode = UIViewContentModeBottom;
        
        bottomNum = 0;
    }
    
    [self removeBgImageView];
    
    // Do any additional setup after loading the view from its nib.
//    self.dataSource = [[NSMutableArray alloc] initWithObjects:@"我的活动", @"线上活动", @"线下活动", @"历史活动", nil];
        self.dataSource = [[NSMutableArray alloc] initWithObjects:@"企业活动", @"体检", nil];
    
    self.listMenu.backgroundColor = [UIColor clearColor];
    self.listMenu.backgroundView = nil;
    self.listMenu.separatorColor = [UIColor clearColor];
    self.listMenu.showsVerticalScrollIndicator = NO;

    [self setExtraCellLineHidden:self.listMenu];
    
    // Do any additional setup after loading the view from its nib.
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_login.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showLfet)];
    
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_message.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showMsg)];
    
    [self.navigationItem.leftBarButtonItem setTintColor:[UIColor whiteColor]];
    [self.navigationItem.rightBarButtonItem setTintColor:[UIColor whiteColor]];
    // Do any additional setup after loading the view from its nib.
}

-(void) showMsg{
    JKMsgMainViewController *msg  = [[JKMsgMainViewController alloc] init];
    msg.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:msg animated:YES];
}

- (void)viewWillAppear:(BOOL)animated
{
    NSString *isHavingMsg = [[NSUserDefaults standardUserDefaults] objectForKey:@"isHavingMsg"];
    if([isHavingMsg isEqualToString:@"Y"]){
        [self showRedMsgBtn];
    }else{
        [self showNoMsgBtn];
    }
    [IQKeyBoardManager disableKeyboardManager];
    [self.navigationController.navigationBar setBackgroundImage:[UIImage new] forBarMetrics:UIBarMetricsDefault];
    self.navigationController.navigationBar.shadowImage = [UIImage new];
}

- (void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    [IQKeyBoardManager enableKeyboardManger];
}

- (void)showLfet
{
#ifndef __NEW_VERSION__
    JKAppDelegate *delegate = (JKAppDelegate *)[UIApplication sharedApplication].delegate;
    [delegate.rootController showLeftController:YES];
#endif
}

- (void)setExtraCellLineHidden: (UITableView *)tableView{
    UIView *view =[ [UIView alloc]init];
    view.backgroundColor = [UIColor clearColor];
    [tableView setTableFooterView:view];
    [tableView setTableHeaderView:view];
}

- (IBAction)CompanyActive:(id)sender {
    if ([[[JKUserUtil currentUser] businessId] length]) {
        JKActivityIndexViewController *vc = [[JKActivityIndexViewController alloc] init];
        vc.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vc animated:YES];
    } else {
        JKBusinessInputView *input = [[JKBusinessInputView alloc] initWithFrame:CGRectMake(0, kNavigationBarHeight + kStatusBarHeight, RECT_WIDTH(self.view), RECT_HEIGHT(self.view) - kNavigationBarHeight - kStatusBarHeight)];
        [self.view addSubview:input];
    }
}

- (IBAction)stepClick:(id)sender {
    
    JKPedViewController *JKPedVC = [JKPedViewController sharePedController];
    [self.navigationController pushViewController:JKPedVC animated:YES];
}

- (IBAction)loginClick:(id)sender {
    JKTestLoginViewController *vc = [[JKTestLoginViewController alloc] init];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];
}

- (IBAction)askClick:(id)sender {
    JKQuickAskDoctorIndexViewController *vc = [[JKQuickAskDoctorIndexViewController alloc] init];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];
}
- (IBAction)settingClick:(id)sender {
    JKSettingViewController *vc = [[JKSettingViewController alloc] init];
    vc.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:vc animated:YES];

}
- (IBAction)personalClick:(id)sender {
    if ([[JKUserUtil currentUser] profileFull]) {
        [self.view makeToast:@"用户信息填写完整" duration:kToastDuration position:@"center"];
    } else {
        IndividualInfoViewController *vc = [[IndividualInfoViewController alloc] init];
        vc.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:vc animated:YES];
    }
}
- (IBAction)guahaoClick:(id)sender {
    if ([[NSUserDefaults standardUserDefaults] objectForKey:@"JKYUYUEGUAHAOCITYDIC"]) {
        JKChooseAreaViewController* choose = [[JKChooseAreaViewController alloc] init];
        choose.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:choose animated:NO];
        
        JKOrderDoctorViewController* order = [[JKOrderDoctorViewController alloc] init];
        [self.navigationController pushViewController:order animated:YES];
    }else{
        JKChooseAreaViewController* choose = [[JKChooseAreaViewController alloc] init];
        choose.hidesBottomBarWhenPushed = YES;
        [self.navigationController pushViewController:choose animated:YES];
    }
}

#pragma mark - UITableViewDelegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return [self.dataSource count] + bottomNum;
}

- (float)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 87;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.row == [self.dataSource count]) {
        
        static NSString *blank = @"blank";
        
        UITableViewCell *blankCell = [tableView dequeueReusableCellWithIdentifier:blank];
        
        if (blankCell == nil) {
            
            blankCell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:blank];
            
            blankCell.selectionStyle = UITableViewCellSelectionStyleNone;
            blankCell.backgroundColor = [UIColor clearColor];
        }
        
        return blankCell;
    }

    
    static NSString *identify = @"identify";
    
    YLListMenuCell *cell = [tableView dequeueReusableCellWithIdentifier:identify];
    
    if (cell == nil) {
        
        NSArray *nibsArray=[[NSBundle mainBundle] loadNibNamed:@"YLListMenuCell" owner:self options:nil];
        
        cell=(YLListMenuCell*)[nibsArray objectAtIndex:0];
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        cell.backgroundColor = [UIColor clearColor];
    }
    
    cell.functionName.text = [self.dataSource objectAtIndex:indexPath.row];
    
    cell.functionImage.image = [UIImage imageNamed:[NSString stringWithFormat:@"%@.png", cell.functionName.text]];
    cell.functionImage.image = [UIImage imageNamed:@"线下活动.png"];
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    //功能点击次数收集
    [TalkingData trackEvent:@"Amuse" label:self.dataSource[indexPath.row]];
    
    switch (indexPath.row) {
        case 0:
        {
            if ([[[JKUserUtil currentUser] businessId] length]) {
                if (![[JKUserUtil currentUser] profileFull]) {
                    IndividualInfoViewController *vc = [[IndividualInfoViewController alloc] init];
                    vc.hidesBottomBarWhenPushed = YES;
                    vc.viewController = @"JKActivityIndexViewController";
                    [self.navigationController pushViewController:vc animated:YES];
                }
                else {
                    //JKActivityIndexViewController *vc = [[JKActivityIndexViewController alloc] init]; //old
                    JKHomeActivityViewController *vc = [[JKHomeActivityViewController alloc] init];
                    vc.hidesBottomBarWhenPushed = YES;
                    [self.navigationController pushViewController:vc animated:YES];
                }
            } else {
                JKBusinessInputView *input = [[JKBusinessInputView alloc] initWithFrame:CGRectMake(0, kNavigationBarHeight + kStatusBarHeight, RECT_WIDTH(self.view), RECT_HEIGHT(self.view) - kNavigationBarHeight - kStatusBarHeight)];
                [self.view addSubview:input];
            }

        }
            break;
        case 1:
        {
//            JKHealthCheckHomeViewController *vc = [[JKHealthCheckHomeViewController alloc] init];
            JKHCProductViewController *vc = [[JKHCProductViewController alloc] init];
            vc.hidesBottomBarWhenPushed = YES;
            [self.navigationController pushViewController:vc animated:YES];
        }
            break;
        case 2:
            [self guahaoClick:nil];
            break;
        case 3:
            [self CompanyActive:nil];
            break;
        case 4:
            [self stepClick:nil];
            break;
        default:
            break;
    }
}

-(void) viewDidAppear:(BOOL)animated{
//    NSString *isHavingMsg = [[NSUserDefaults standardUserDefaults] objectForKey:@"isHavingMsg"];
//    if([isHavingMsg isEqualToString:@"Y"]){
//        [self showRedMsgBtn];
//    }else{
//        [self showNoMsgBtn];
//    }
}

-(void)showRedMsgBtn{
    RedBtn *btn = [[RedBtn alloc] initWithFrame:CGRectMake(0, 0, 57/2.0f, 57/2.0f)];
    [btn setBackgroundImage:[UIImage imageNamed:@"nav_bar_message.png"] forState:UIControlStateNormal];
    [btn addTarget:self action:@selector(showMsg) forControlEvents:UIControlEventTouchUpInside];
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:btn];
}

-(void) showNoMsgBtn{
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_message.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showMsg)];
    [self.navigationItem.rightBarButtonItem setTintColor:[UIColor whiteColor]];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
