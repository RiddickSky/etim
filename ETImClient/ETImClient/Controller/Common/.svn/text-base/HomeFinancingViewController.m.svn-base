//
//  HomeFinancingViewController.m
//  HM-HEALTH
//
//  Created by apple on 14-5-26.
//  Copyright (c) 2014年 PingAn. All rights reserved.
//

#import "HomeFinancingViewController.h"
#import "YLMainWebViewController.h"
#import "UIImage+Color.h"
#import "YLListMenuCell.h"
#import "JKMsgMainViewController.h"
#import "JKMsgUtil.h"

@interface HomeFinancingViewController ()<UITableViewDataSource, UITableViewDelegate>
{
    ///显示底部空白行数量
    int bottomNum;
}
@property (nonatomic, strong) NSMutableArray *dataSource;

@end

@implementation HomeFinancingViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        self.title = @"理财宝";
        self.navigationItem.title = @"";
        [self.tabBarItem setFinishedSelectedImage:[UIImage imageNamed:@"tab_finance_selected.png"] withFinishedUnselectedImage:[UIImage imageNamed:@"tab_finance_unselect.png"]];
        // Custom initialization

    }
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(showRedMsgBtn) name:@"HAVE_MSG" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(showNoMsgBtn) name:@"HAVE_NO_MSG" object:nil];
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    bottomNum = 1;
    
    if (!IOS7) {
        CGRect frame = self.listMenu.frame;
        frame.origin.y -= 40;
        frame.size.height += 40;
        [self.listMenu setFrame:frame];
        
        self.bgImage.image = [UIImage imageNamed:@"home_back_OS6"];
        self.bgImage.contentMode = UIViewContentModeBottom;
        bottomNum = 0;
    }
    
    [self removeBgImageView];
    
    self.dataSource = [[NSMutableArray alloc] initWithObjects:@"保险",nil];
    
    self.listMenu.backgroundColor = [UIColor clearColor];
    self.listMenu.backgroundView = nil;
    self.listMenu.separatorColor = [UIColor clearColor];
    self.listMenu.showsVerticalScrollIndicator = NO;

    [self setExtraCellLineHidden:self.listMenu];

    // Do any additional setup after loading the view from its nib.
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_login.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showLfet)];
    
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_message.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showMsg)];
    
    [self.navigationItem.leftBarButtonItem setTintColor:[UIColor whiteColor]];
    [self.navigationItem.rightBarButtonItem setTintColor:[UIColor whiteColor]];
    // Do any additional setup after loading the view from its nib.
}

-(void) showMsg{
    JKMsgMainViewController *msg  = [[JKMsgMainViewController alloc] init];
    msg.hidesBottomBarWhenPushed = YES;
    [self.navigationController pushViewController:msg animated:YES];
}

- (void)viewWillAppear:(BOOL)animated
{
    NSString *isHavingMsg = [[NSUserDefaults standardUserDefaults] objectForKey:@"isHavingMsg"];
    if([isHavingMsg isEqualToString:@"Y"]){
        [self showRedMsgBtn];
    }else{
        [self showNoMsgBtn];
    }
    [self.navigationController.navigationBar setBackgroundImage:[UIImage new] forBarMetrics:UIBarMetricsDefault];
    self.navigationController.navigationBar.shadowImage = [UIImage new];
}

- (void)showLfet
{
#ifndef __NEW_VERSION__
    JKAppDelegate *delegate = (JKAppDelegate *)[UIApplication sharedApplication].delegate;
    [delegate.rootController showLeftController:YES];
#endif
}

- (void)setExtraCellLineHidden: (UITableView *)tableView{
    UIView *view =[ [UIView alloc]init];
    view.backgroundColor = [UIColor clearColor];
    [tableView setTableFooterView:view];
    [tableView setTableHeaderView:view];
}

//保险
- (IBAction)insuranceClick:(UIButton *)sender {
    
    YLMainWebViewController *ylMainVC = [[YLMainWebViewController alloc] init];
    
    ylMainVC.hidesBottomBarWhenPushed = YES;
    
    [ylMainVC startLoadWebViewWithUrlString:[NSString stringWithFormat:@"%@/m/insurance/index.html", CSSP_HOST_URL]];
    
    ylMainVC.javascriptString = @"javascript:forward('#insurance/financialMarket/insuranceHome/index')";
    
    [self.navigationController pushViewController:ylMainVC animated:YES];
//    [ylMainVC createCenterView];
}

//投资
- (IBAction)investClick:(UIButton *)sender {


}

//订单
- (IBAction)orderClick:(UIButton *)sender {
    YLMainWebViewController *ylMainVC = [[YLMainWebViewController alloc] init];
    
    ylMainVC.hidesBottomBarWhenPushed = YES;
    
    [ylMainVC startLoadWebViewWithUrlString:[NSString stringWithFormat:@"%@/m/insurance/index.html#service/orderManager/insuranceOrder/index", CSSP_HOST_URL]];
    
    [self.navigationController pushViewController:ylMainVC animated:YES];    
}

#pragma mark - UITableViewDelegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return [self.dataSource count] + bottomNum;
}

- (float)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return 87;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    if (indexPath.row == [self.dataSource count]) {
        
        static NSString *blank = @"blank";
        
        UITableViewCell *blankCell = [tableView dequeueReusableCellWithIdentifier:blank];
        
        if (blankCell == nil) {
            
            blankCell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:blank];
            
            blankCell.selectionStyle = UITableViewCellSelectionStyleNone;
            blankCell.backgroundColor = [UIColor clearColor];
        }
        
        return blankCell;
    }

    
    static NSString *identify = @"identify";
    
    YLListMenuCell *cell = [tableView dequeueReusableCellWithIdentifier:identify];
    
    if (cell == nil) {
        
        NSArray *nibsArray=[[NSBundle mainBundle] loadNibNamed:@"YLListMenuCell" owner:self options:nil];
        
        cell=(YLListMenuCell*)[nibsArray objectAtIndex:0];
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        cell.backgroundColor = [UIColor clearColor];
    }
    
    cell.functionName.text = [self.dataSource objectAtIndex:indexPath.row];
    
    cell.functionImage.image = [UIImage imageNamed:[NSString stringWithFormat:@"%@.png", cell.functionName.text]];

    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    //功能点击次数收集
    [TalkingData trackEvent:@"Financing" label:self.dataSource[indexPath.row]];
    
    switch (indexPath.row) {
        case 0:
            [self insuranceClick:nil];
            break;
        default:
            break;
    }
}

-(void) viewDidAppear:(BOOL)animated{
//    NSString *isHavingMsg = [[NSUserDefaults standardUserDefaults] objectForKey:@"isHavingMsg"];
//    if([isHavingMsg isEqualToString:@"Y"]){
//        [self showRedMsgBtn];
//    }else{
//        [self showNoMsgBtn];
//    }
    
}

-(void)showRedMsgBtn{
    RedBtn *btn = [[RedBtn alloc] initWithFrame:CGRectMake(0, 0, 57/2.0f, 57/2.0f)];
    [btn setBackgroundImage:[UIImage imageNamed:@"nav_bar_message.png"] forState:UIControlStateNormal];
    [btn addTarget:self action:@selector(showMsg) forControlEvents:UIControlEventTouchUpInside];
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:btn];
}

-(void)showNoMsgBtn{
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithImage:[UIImage imageNamed:@"nav_bar_message.png"] style:UIBarButtonItemStyleBordered target:self action:@selector(showMsg)];
    [self.navigationItem.rightBarButtonItem setTintColor:[UIColor whiteColor]];
}
- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
