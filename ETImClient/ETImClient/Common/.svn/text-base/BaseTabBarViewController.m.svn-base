//
//  BaseTabBarViewController.m
//  HM-HEALTH
//
//  Created by apple on 14-6-3.
//  Copyright (c) 2014年 PingAn. All rights reserved.
//

#import "BaseTabBarViewController.h"
#import "PALeftViewController.h"
#import "JKAppDelegate.h"
#import "JKSettingViewController.h"
#import "UIImage+Color.h"
#import "UIImage+Cut.h"
#import "YLMainWebViewController.h"
#import "NSHTTPCookieStorage+Web.h"
#import "JKCompanyCodeViewController.h"
#import "IndividualInfoViewController.h"

#import "YLIdentityAuthenticationViewController.h"

#import "PatternInfo.h"

@interface BaseTabBarViewController ()<PALeftDelegate, UIAlertViewDelegate>
{
    JKAppDelegate *delegate;
    id selectedVC;
}

@end

@implementation BaseTabBarViewController


- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    [[UITabBarItem
    appearance] setTitleTextAttributes:[NSDictionary
                                        dictionaryWithObjectsAndKeys: [UIColor whiteColor],
                                        UITextAttributeTextColor,
                                        [UIFont fontWithName:nil size:12], UITextAttributeFont,
                                        nil] forState:UIControlStateNormal];
    
    self.tabBar.tintColor = [UIColor whiteColor];
    delegate = (JKAppDelegate *)[UIApplication sharedApplication].delegate;

    UIImage *bgImg = [[[UIImage alloc] init] autorelease];
    [self.tabBar setBackgroundImage:bgImg];
    [self.tabBar setShadowImage:bgImg];
    
    [[UITabBar appearance] setSelectedImageTintColor:[UIColor colorWithRed:127.0/255.0 green:186.0/255.0 blue:235.0/255.0 alpha:1.0]];
    [[UITabBar appearance] setSelectionIndicatorImage:bgImg];
    //上面两个是清除item的背景色跟选中背景色
    
#ifndef __NEW_VERSION__
    self.tabBar.backgroundImage = [UIImage createImageWithColor:[UIColor colorWithRed:0 green:0 blue:0 alpha:0.5]];
    
    if (!IsIOS7) {
        self.tabBar.superview.backgroundColor = [UIColor clearColor];
        self.tabBar.backgroundImage = [UIImage imageNamed:@"home_tab_OS6"];
    }
#else
    self.tabBar.backgroundColor = [UIColor blackColor];
    self.tabBar.backgroundImage = [UIImage imageNamed:@"new_nav_bg.png"];
#endif
}

- (void)respondsSelectEventWithVC:(PALeftViewController *)viewController
{
    viewController.delegate = self;
}

- (void)leftTableViewSelectRow:(int)row
{
    NSLog(@"你选择了%d行", row);
        
    //判断跳转的 vc 是否为 当前页面vc
    // 添加 selectedVC
    NSArray *navViewcontrollers = [(UINavigationController *)self.viewControllers[self.selectedIndex] viewControllers];
    for (UIViewController *viewController in navViewcontrollers) {
        
        if (selectedVC == viewController) {
            UIViewController *pushViewController = navViewcontrollers[ [navViewcontrollers indexOfObject:viewController] - 1];
            [self.viewControllers[self.selectedIndex] popToViewController:pushViewController animated:NO];
            break;
        }
    }
    
    switch (row) {
        case 0:
        {
            [delegate.rootController showRootController:YES];

            YLMainWebViewController *ylWebVC = [[YLMainWebViewController alloc] init];
            
            ylWebVC.hidesBottomBarWhenPushed = YES;
            [ylWebVC startLoadWebViewWithUrlString:[NSString stringWithFormat:@"%@/m/insurance/index.html", CSSP_HOST_URL]];
            ylWebVC.javascriptString = @"javascript:forward('#service/orderManager/insuranceOrder/index/2')";
            [self.viewControllers[self.selectedIndex] pushViewController:ylWebVC animated:YES];
            
            selectedVC = ylWebVC;
        }
            break;
            
        case 1 :
        {
            [delegate.rootController showRootController:YES];
            JKCompanyCodeViewController *vc=[[JKCompanyCodeViewController alloc] init];
            vc.hidesBottomBarWhenPushed = YES;
            
            [self.viewControllers[self.selectedIndex] pushViewController:vc animated:YES];
            
            selectedVC = vc;
        }
            break;
        case 2:
        {
            [delegate.rootController showRootController:YES];

            JKSettingViewController *vc = [[JKSettingViewController alloc] init];
            vc.hidesBottomBarWhenPushed = YES;

            [self.viewControllers[self.selectedIndex] pushViewController:vc animated:YES];
            selectedVC = vc;
        }
            break;
        case 3:
        {
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"是否确定退出？" message:nil delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确定", nil];

            [alert show];

        }
            break;
        case 4:
        {
           //银行卡
            [delegate.rootController showRootController:YES];
            
            YLIdentityAuthenticationViewController *identityAuthenticationVC = [[YLIdentityAuthenticationViewController alloc] initWithNibName:@"YLIdentityAuthenticationViewController" bundle:nil];

            identityAuthenticationVC.hidesBottomBarWhenPushed = YES;
            [self.viewControllers[self.selectedIndex] pushViewController:identityAuthenticationVC animated:YES];
            selectedVC = identityAuthenticationVC;
        }
            break;
        case 1000:
        {
            [delegate.rootController showRootController:YES];
            
            IndividualInfoViewController *vc = [[IndividualInfoViewController alloc] init];
            vc.hidesBottomBarWhenPushed = YES;
            selectedVC = vc;
            [self.viewControllers[self.selectedIndex] pushViewController:vc animated:YES];
        }
            break;
        default:
            break;
    }
}

- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex == 1) {
        [[self class] jumpToLogin];
        /*
        [delegate.rootController showRootController:NO];
        
        JKAppDelegate *appDelegate = (JKAppDelegate *)[[UIApplication sharedApplication] delegate];
        
        [appDelegate.rootController dismissViewControllerAnimated:YES completion:^{
            [[NSHTTPCookieStorage sharedHTTPCookieStorage] deleteUserLoginCookie];
            
            [[NSUserDefaults standardUserDefaults] setValue:nil forKey:kTxtInfo];
            
            [[NSUserDefaults standardUserDefaults] synchronize];
        }];
         */
    }
}

+ (void)jumpToLogin {
    
    JKAppDelegate *delegate = (JKAppDelegate *)[[UIApplication sharedApplication] delegate];
    
#ifndef __NEW_VERSION__
    [delegate.rootController showRootController:NO];
#endif
    [delegate.rootController dismissViewControllerAnimated:YES completion:^{
        [[NSHTTPCookieStorage sharedHTTPCookieStorage] deleteUserLoginCookie];
        
        [[NSUserDefaults standardUserDefaults] setValue:nil forKey:kTxtInfo];
        
        [[NSUserDefaults standardUserDefaults] synchronize];
        
//        [[PatternInfo sharePatternInfo] resertGes];
    }];

}

+ (void)showTokenFailure:(UIView *)view {
    [view makeToast:@"当前网络不稳定" duration:kToastDuration position:@"center"];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
