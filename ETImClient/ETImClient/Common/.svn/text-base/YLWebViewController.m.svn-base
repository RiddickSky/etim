//
//  YLWebViewController.m
//  HM-HEALTH
//
//  Created by apple on 14-5-29.
//  Copyright (c) 2014年 PingAn. All rights reserved.
//

#import "YLWebViewController.h"

@interface YLWebViewController ()<UIWebViewDelegate>
{
    NSURL *webUrl;
}

@property (nonatomic, strong) NSString* loadUrlStr;

@end

@implementation YLWebViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    [self removeBgImageView];
    
//    self.bPushView = YES;
    
    NSURLRequest *request = [[NSURLRequest alloc] initWithURL:webUrl];
    self.webView.delegate = self;
    self.webView.userInteractionEnabled = YES;
    self.webView.scalesPageToFit = YES;
    
    UIButton *backBtn = [[UIButton alloc] init];
    [backBtn addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
    [backBtn setImage:IMAGE(@"Activity_back@2x.png") forState:UIControlStateNormal];
    [backBtn setImage:IMAGE(@"Activity_back@2x.png") forState:UIControlStateHighlighted];
    backBtn.contentMode = UIViewContentModeCenter;
    backBtn.frame = CGRectMake(3, 0, 31, 31);
    
    UIBarButtonItem *negativeSpacerR = [[UIBarButtonItem alloc]
                                        initWithBarButtonSystemItem:UIBarButtonSystemItemFixedSpace
                                        target:nil action:nil];
    if (IOS7) {
        negativeSpacerR.width = -10;
    }else{
        negativeSpacerR.width = 3;
    }
    
    self.navigationItem.leftBarButtonItems = @[negativeSpacerR, [[UIBarButtonItem alloc] initWithCustomView:backBtn]];

    double delayInSeconds = 0.5;
    dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC));
    dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
        
        [self.webView loadRequest:request];

    });
    
    // Do any additional setup after loading the view from its nib.
}

- (void)back
{
    self.webView.delegate = nil;
    
    if (self.bPushView) {
        [self.navigationController popViewControllerAnimated:YES];
    }
    else
    {
        [self dismissViewControllerAnimated:NO completion:nil];
    }
}

- (void)loadWebWithURLString:(NSString *)urlstring
{
    webUrl=[[NSURL alloc] initWithString:[urlstring stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding]];
}



- (void)delayLoadRequest
{
    NSURL *url = [NSURL URLWithString:K_MONEY];
    
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url];
    
    [request setHTTPMethod: @"POST"];
    [request setHTTPBody: [_loadUrlStr dataUsingEncoding: NSUTF8StringEncoding]];
    [_webView loadRequest: request];
}

- (void)postByDictionary:(NSString*)urlStr
{
    self.loadUrlStr = urlStr;
    [self performSelector:@selector(delayLoadRequest)
               withObject:nil
               afterDelay:.5];

}

- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType
{
    NSString *urlString = [request.URL absoluteString];
    
    urlString = [urlString stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    
    NSLog(@"%@", urlString);
    
    if ([urlString containsString:@"#service/orderManager/insuranceOrder/index"]) {
        [[NSNotificationCenter defaultCenter] postNotificationName:@"kKuaiQIanPaySuccess" object:nil];
        [self.navigationController popViewControllerAnimated:YES];
        return NO;
    }
    
    return YES;
}
- (void)webViewDidStartLoad:(UIWebView *)webView
{
    [HMLoadingView showLoading:self.view];
}

- (void)webViewDidFinishLoad:(UIWebView *)webView
{
    [HMLoadingView hideLoading:self.view];
}

- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error
{
    NSString* prompt = nil;
    
    if (error && error.code != 101) {
        if (ASIRequestTimedOutErrorType == error.code) {
            prompt = @"请求超时";
        }else {
            prompt = @"网络异常";
        }
        //    UIAlertView *alert = [[UIAlertView alloc] initWithTitle:nil message:prompt delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
        //    [alert show];
        [Util alertViewWithTitle:nil
                         message:prompt
                     buttonTitle:nil
                            view:self.view];
    }
    [HMLoadingView hideLoading:self.view];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
